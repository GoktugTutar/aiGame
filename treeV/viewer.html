<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>AI Analiz - Dinamik YÃ¼kleme</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #eef2f5; 
            margin: 0; 
            padding: 20px; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            overflow: hidden; 
        }

        /* BAÅžLIK VE KONTROLLER (Hemen YÃ¼klenir) */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }
        
        .controls button {
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 5px;
            margin-left: 5px;
            transition: background 0.2s;
        }
        .controls button:hover { background: #34495e; }
        .controls button:disabled { background: #bdc3c7; cursor: not-allowed; }
        .turn-indicator { font-size: 1.1em; font-weight: bold; color: #2c3e50; margin-right: 20px;}

        /* ANA EKRAN */
        .main-container {
            display: flex;
            flex: 1; 
            gap: 20px;
            min-height: 0;
            position: relative; /* Loading ekranÄ± iÃ§in */
        }

        /* SOL PANEL */
        .board-panel {
            flex: 0 0 320px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            overflow-y: auto;
        }
        
        .game-grid {
            display: grid;
            grid-template-columns: repeat(7, 40px);
            grid-template-rows: repeat(7, 40px);
            gap: 4px;
            background-color: #333;
            padding: 4px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .cell { width: 40px; height: 40px; background-color: #bdc3c7; display: flex; align-items: center; justify-content: center; }
        .pawn-ai { width: 30px; height: 30px; background-color: #3498db; border-radius: 50%; border: 2px solid #2980b9; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .pawn-hu { width: 30px; height: 30px; background-color: #e74c3c; border-radius: 50%; border: 2px solid #c0392b; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .barrier { width: 36px; height: 36px; background-color: #2c3e50; border-radius: 4px; }

        /* SAÄž PANEL */
        .tree-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }

        /* LOADING EKRANI */
        #loading-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* AÄžAÃ‡ STÄ°LLERÄ° */
        .node { cursor: pointer; }
        .node circle { fill: #fff; stroke: steelblue; stroke-width: 2px; transition: all 0.3s; }
        .node text { font: 12px sans-serif; pointer-events: none; font-weight: bold; text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff;}
        .link { fill: none; stroke: #ccc; stroke-width: 1.5px; }
        .node--pruned circle { stroke-dasharray: 4; }
        .legend { margin-top: 10px; font-size: 0.85em; color: #666; text-align:center; padding: 0 10px;}
        .dot { width: 10px; height: 10px; display: inline-block; border-radius: 50%; margin-right: 5px; }
    </style>
</head>
<body>

    <div class="header">
        <div><h3>AI Oyun Analizi</h3></div>
        <div class="controls">
            <span class="turn-indicator">Hamle: <span id="turn-display">-</span></span>
            <button id="prev-btn" onclick="changeTurn(-1)" disabled>&#8592; Geri</button>
            <button id="next-btn" onclick="changeTurn(1)" disabled>Ä°leri &#8594;</button>
            <button onclick="location.reload()" style="background:#27ae60; margin-left:15px;">ðŸ”„ Yenile</button>
        </div>
    </div>

    <div class="main-container">
        <div id="loading-overlay">
            <div class="spinner"></div>
            <div id="loading-text" style="font-size:1.2em; color:#333;">Oyun verisi yÃ¼kleniyor...</div>
            <div style="font-size:0.9em; color:#666; margin-top:5px;">(BÃ¼yÃ¼k dosyalarda biraz zaman alabilir)</div>
        </div>

        <div class="board-panel">
            <h4>Oyun TahtasÄ±</h4>
            <div id="game-board" class="game-grid"></div>
            <div class="legend">
                <div style="margin-bottom:5px;"><span class="dot" style="background:#3498db"></span>AI (Mavi / MAX)</div>
                <div style="margin-bottom:5px;"><span class="dot" style="background:#e74c3c"></span>Ä°nsan (KÄ±rmÄ±zÄ± / MIN)</div>
                <div style="margin-bottom:15px;"><span class="dot" style="background:#2c3e50"></span>Engel</div>
                <div style="border-top:1px solid #eee; padding-top:10px; font-size:0.8em; color:#888;">
                    Dallar Ã§ok fazlaysa otomatik gizlenir.<br>Gri dairelere tÄ±klayarak aÃ§abilirsiniz.
                </div>
            </div>
        </div>

        <div id="tree-container" class="tree-panel"></div>
    </div>

    <script>
        // Ayarlar
        const EMPTY = 0, AI_PAWN = 1, HU_PAWN = 2, BLOCKED = -1;
        let currentTurnIndex = 0;

        // Sayfa yÃ¼klendiÄŸinde Ã§alÄ±ÅŸacak fonksiyon
        document.addEventListener("DOMContentLoaded", () => {
            loadGameData();
        });

        // 1. VERÄ°YÄ° DOSYADAN DÄ°NAMÄ°K YÃœKLEME
        function loadGameData() {
            const script = document.createElement('script');
            // 't' parametresi tarayÄ±cÄ±nÄ±n eski dosyayÄ± Ã¶nbellekten (cache) okumasÄ±nÄ± engeller.
            script.src = 'game_data.js?t=' + new Date().getTime(); 
            
            script.onload = () => {
                // Dosya yÃ¼klendiÄŸinde Ã§alÄ±ÅŸÄ±r
                const loader = document.getElementById('loading-overlay');
                
                if (typeof GAME_DATA === 'undefined' || GAME_DATA.length === 0) {
                    document.getElementById('loading-text').innerHTML = 
                        "<span style='color:red'>Veri boÅŸ veya hatalÄ±!</span><br>game_data.js dosyasÄ±nÄ± kontrol edin.";
                    document.querySelector('.spinner').style.display = 'none';
                } else {
                    // BaÅŸarÄ±lÄ± yÃ¼kleme
                    loader.style.display = 'none'; // Loading'i gizle
                    renderAll(0); // Ä°lk hamleyi Ã§iz
                }
            };

            script.onerror = () => {
                document.getElementById('loading-text').innerHTML = 
                    "<span style='color:red'>game_data.js BulunamadÄ±!</span><br>LÃ¼tfen C++ oyununu oynayÄ±p kapatÄ±n.<br>VS Code Live Server kullandÄ±ÄŸÄ±nÄ±zdan emin olun.";
                document.querySelector('.spinner').style.display = 'none';
            };

            document.body.appendChild(script);
        }

        // 2. NAVÄ°GASYON
        function changeTurn(delta) {
            if (typeof GAME_DATA === 'undefined') return;
            const newIndex = currentTurnIndex + delta;
            if (newIndex >= 0 && newIndex < GAME_DATA.length) {
                currentTurnIndex = newIndex;
                renderAll(currentTurnIndex);
            }
        }

        // 3. ANA RENDER FONKSÄ°YONU
        function renderAll(index) {
            const data = GAME_DATA[index];
            
            document.getElementById('turn-display').innerText = data.turn;
            document.getElementById('prev-btn').disabled = index === 0;
            document.getElementById('next-btn').disabled = index === GAME_DATA.length - 1;

            drawBoard(data.board);
            drawCollapsibleTree(data.nodes);
        }

        // 4. TAHTA Ã‡Ä°ZÄ°MÄ°
        function drawBoard(boardMatrix) {
            const container = document.getElementById('game-board');
            container.innerHTML = ''; 
            for (let r = 0; r < 7; r++) {
                for (let c = 0; c < 7; c++) {
                    const cellVal = boardMatrix[r][c];
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'cell';
                    if (cellVal === AI_PAWN) {
                        const piece = document.createElement('div'); piece.className = 'pawn-ai'; cellDiv.appendChild(piece);
                    } else if (cellVal === HU_PAWN) {
                        const piece = document.createElement('div'); piece.className = 'pawn-hu'; cellDiv.appendChild(piece);
                    } else if (cellVal === BLOCKED) {
                        const block = document.createElement('div'); block.className = 'barrier'; cellDiv.appendChild(block);
                    }
                    container.appendChild(cellDiv);
                }
            }
        }

        // 5. OPTÄ°MÄ°ZE EDÄ°LMÄ°Åž AÄžAÃ‡ (COLLAPSIBLE)
        function drawCollapsibleTree(flatNodes) {
            const container = document.getElementById("tree-container");
            container.innerHTML = "";

            // HiyerarÅŸiyi oluÅŸtur
            const dataMap = {};
            flatNodes.forEach(n => dataMap[n.id] = { ...n, children: [] });
            let rootData = null;
            flatNodes.forEach(n => {
                if (n.parent === -1) rootData = dataMap[n.id];
                else if (dataMap[n.parent]) dataMap[n.parent].children.push(dataMap[n.id]);
            });

            if (!rootData) return;

            const width = container.clientWidth;
            const height = container.clientHeight;
            const treeLayout = d3.tree().nodeSize([50, 120]);
            
            const root = d3.hierarchy(rootData);
            root.x0 = height / 2; root.y0 = 0;

            // Gizleme (Collapse) mantÄ±ÄŸÄ±
            function collapse(d) {
                if (d.children) {
                    d._children = d.children;
                    d._children.forEach(collapse);
                    d.children = null;
                }
            }
            if(root.children) root.children.forEach(collapse);

            const svg = d3.select("#tree-container").append("svg")
                .attr("width", width).attr("height", height)
                .call(d3.zoom().on("zoom", (e) => g.attr("transform", e.transform)))
                .append("g").attr("transform", "translate(80,50)");

            const g = svg;
            update(root);

            function update(source) {
                const treeData = treeLayout(root);
                const nodes = treeData.descendants();
                const links = treeData.links();

                const node = g.selectAll('g.node').data(nodes, d => d.data.id);

                const nodeEnter = node.enter().append('g')
                    .attr('class', 'node')
                    .attr("transform", d => `translate(${source.y0},${source.x0})`)
                    .on('click', (event, d) => {
                        if (d.children) { d._children = d.children; d.children = null; } 
                        else { d.children = d._children; d._children = null; }
                        update(d);
                    });

                nodeEnter.append('circle')
                    .attr('r', 1e-6)
                    .style("fill", d => d._children ? "lightsteelblue" : "#fff");

                nodeEnter.append('text')
                    .attr("dy", ".35em")
                    .attr("x", d => d.children || d._children ? -13 : 13)
                    .attr("text-anchor", d => d.children || d._children ? "end" : "start")
                    .text(d => d.data.score > 900000 ? "WIN" : (d.data.score < -900000 ? "LOSE" : d.data.score));
                
                nodeEnter.append("title").text(d => `Skor: ${d.data.score}\nDerinlik: ${d.data.depth}\nInfo: ${d.data.info}`);

                const nodeUpdate = nodeEnter.merge(node);
                nodeUpdate.transition().duration(200).attr("transform", d => `translate(${d.y},${d.x})`);
                nodeUpdate.select('circle').attr('r', 8)
                    .style("fill", d => d._children ? "#95a5a6" : (d.data.type==="MAX" ? "#d4edda" : "#f8d7da"))
                    .style("stroke", d => d.data.type==="MAX" ? "#27ae60" : "#c0392b");

                const nodeExit = node.exit().transition().duration(200)
                    .attr("transform", d => `translate(${source.y},${source.x})`).remove();
                nodeExit.select('circle').attr('r', 1e-6);

                const link = g.selectAll('path.link').data(links, d => d.target.data.id);
                const linkEnter = link.enter().insert('path', "g").attr("class", "link")
                    .attr('d', d => { const o = {x: source.x0, y: source.y0}; return diagonal(o, o); });
                
                linkEnter.merge(link).transition().duration(200).attr('d', d => diagonal(d.source, d.target));
                link.exit().transition().duration(200)
                    .attr('d', d => { const o = {x: source.x, y: source.y}; return diagonal(o, o); }).remove();

                nodes.forEach(d => { d.x0 = d.x; d.y0 = d.y; });
            }

            function diagonal(s, d) {
                return `M ${s.y} ${s.x} C ${(s.y + d.y) / 2} ${s.x}, ${(s.y + d.y) / 2} ${d.x}, ${d.y} ${d.x}`;
            }
        }
    </script>
</body>
</html>